{% include 'partials/head.liquid' %}
{% include 'partials/header.liquid' %}

<main class="tickets-page">
    <h1 class="tickets-h1">BOOK YOUR TICKETS</h1>

    <form method="POST" action="/tickets" class="multi-step-form">

        <nav class="step-navigation" aria-label="Progress">
            <ul>
                <li data-step="1" class="active">1. SELECT TICKETS</li>
                <li data-step="2">2. PICK A DATE</li>
                <li data-step="3">3. YOUR INFORMATION</li>
                <li data-step="4">4. REVIEW</li>
                <li data-step="5">5. PAYMENT</li>
                <li data-step="6">6. CONFIRMATION</li>
            </ul>
        </nav>

        <!-- STEP 1 -->
        <fieldset data-step="1">
            <legend>1. Select Tickets</legend>
            <section class="museum-list">
                {% for museum in museums %}
                    <article class="museum-card">
                        <div class="museum-info">
                            <input type="radio" name="museum_id" id="museum-{{ museum.id }}" value="{{ museum.id }}" required>
                            <label for="museum-{{ museum.id }}">
                                <h3>{{ museum.name }}</h3>
                                <p>{{ museum.description }}</p>
                                {% if museum.exhibitions %}
                                    <strong>Current Exhibitions:</strong>
                                    <ul>
                                        {% for ex in museum.exhibitions %}
                                            <li><em>{{ ex }}</em></li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </label>
                        </div>
                        <div class="museum-image">
                            <img src="{{ museum.image }}" alt="Image of {{ museum.name }}" loading="lazy">
                        </div>
                        <div class="ticket-table-wrapper">
                            <table class="ticket-table">
                                <thead>
                                <tr><th>Ticket</th><th>Qty</th><th>Subtotal</th></tr>
                                </thead>
                                <tbody>
                                {% for ticket in museum.tickets %}
                                    <tr>
                                        <td><strong>{{ ticket.label }}</strong></td>
                                        <td>
                                            <button class="decrease">–</button>
                                            <input type="number" min="0" value="0" class="ticket-qty" data-price="{{ ticket.price }}">
                                            <button class="increase">+</button>
                                        </td>
                                        <td class="subtotal">QAR 0</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </article>
                {% endfor %}
            </section>

            <aside class="cart-summary">
                <h3>Your Cart</h3>
                <p>Total: QAR <span id="cart-total">0</span></p>
                <button type="button" class="next-step">Next</button>
            </aside>
        </fieldset>

        <!-- STEP 2–6 (simplified for space) -->
        <fieldset data-step="2" hidden>
            <legend>2. Pick a Date</legend>
            <input type="date" name="visit_date" required>
            <div class="step-buttons">
                <button type="button" class="prev-step">Previous</button>
                <button type="button" class="next-step">Next</button>
            </div>
        </fieldset>

        <fieldset data-step="3" hidden>
            <legend>3. Your Information</legend>
            <label>First Name <input name="first_name" required></label>
            <label>Last Name <input name="last_name" required></label>
            <label>Email <input name="email" type="email" required></label>
            <label>Phone <input name="phone" type="tel" required></label>
            <div class="step-buttons">
                <button type="button" class="prev-step">Previous</button>
                <button type="button" class="next-step">Next</button>
            </div>
        </fieldset>

        <fieldset data-step="4" hidden>
            <legend>4. Review</legend>
            <ul class="review-list">
                <li><strong>Name:</strong> <span id="review-name"></span></li>
                <li><strong>Email:</strong> <span id="review-email"></span></li>
                <li><strong>Date:</strong> <span id="review-date"></span></li>
            </ul>
            <div class="step-buttons">
                <button type="button" class="prev-step">Previous</button>
                <button type="button" class="next-step">Next</button>
            </div>
        </fieldset>

        <fieldset data-step="5" hidden>
            <legend>5. Payment</legend>
            <p>Card UI or integration goes here.</p>
            <div class="step-buttons">
                <button type="button" class="prev-step">Previous</button>
                <button type="button" class="next-step">Next</button>
            </div>
        </fieldset>

        <fieldset data-step="6" hidden>
            <legend>6. Confirmation</legend>
            <p>✅ Booking complete! Email sent.</p>
            <button type="submit" class="submit-final">Finish</button>
        </fieldset>
    </form>
</main>

<script>
    let currentStep = 1;
    const totalSteps = 6;

    function showStep(step) {
        // Show only the current fieldset
        document.querySelectorAll("fieldset").forEach(fs =>
            fs.hidden = parseInt(fs.dataset.step) !== step
        );

        // Highlight current nav step
        document.querySelectorAll(".step-navigation li").forEach(nav =>
            nav.classList.toggle("active", parseInt(nav.dataset.step) === step)
        );

        if (step === 4) updateReview(); // Fill review preview
        currentStep = step;
    }

    // Fill review summary
    function updateReview() {
        document.getElementById("review-name").textContent =
            document.querySelector("[name='first_name']").value + ' ' +
            document.querySelector("[name='last_name']").value;
        document.getElementById("review-email").textContent =
            document.querySelector("[name='email']").value;
        document.getElementById("review-date").textContent =
            document.querySelector("[name='visit_date']").value;
    }

    document.addEventListener("DOMContentLoaded", () => {
        showStep(currentStep); // Init UI to step 1

        // Navigation buttons
        document.querySelectorAll(".next-step").forEach(btn =>
            btn.addEventListener("click", () => {
                if (currentStep < totalSteps) showStep(currentStep + 1);
            })
        );
        document.querySelectorAll(".prev-step").forEach(btn =>
            btn.addEventListener("click", () => {
                if (currentStep > 1) showStep(currentStep - 1);
            })
        );

        // Subtotal calculation
        const updateSubtotal = input => {
            const price = parseFloat(input.dataset.price || 0);
            const qty = parseInt(input.value || 0);
            const row = input.closest("tr");
            row.querySelector(".subtotal").textContent = `QAR ${price * qty}`;
            updateCartTotal();
        };

        const updateCartTotal = () => {
            let total = 0;
            document.querySelectorAll(".ticket-qty").forEach(input => {
                total += parseFloat(input.dataset.price) * parseInt(input.value || 0);
            });
            document.getElementById("cart-total").textContent = total.toFixed(2);
        };

        // Button events
        document.querySelectorAll(".increase").forEach(btn =>
            btn.addEventListener("click", () => {
                const input = btn.previousElementSibling;
                input.value = parseInt(input.value || 0) + 1;
                updateSubtotal(input);
            })
        );
        document.querySelectorAll(".decrease").forEach(btn =>
            btn.addEventListener("click", () => {
                const input = btn.nextElementSibling;
                input.value = Math.max(0, parseInt(input.value || 0) - 1);
                updateSubtotal(input);
            })
        );
        document.querySelectorAll(".ticket-qty").forEach(input =>
            input.addEventListener("input", () => updateSubtotal(input))
        );
    });

</script>

{% include 'partials/foot.liquid' %}
